<!DOCTYPE html>
<html>
<head>
  <title>Infosys Stock Tracker</title>
  <style>
    body { font-family:"Segoe UI",Arial; background:#0f172a; color:#e5e7eb; padding:20px; }
    .container { max-width:1200px; margin:auto; background:#020617; padding:25px; border-radius:14px; box-shadow:0 0 25px rgba(0,0,0,0.6);}
    h1{text-align:center;color:#38bdf8;margin-bottom:5px;}
    .subtitle{text-align:center;color:#94a3b8;margin-bottom:15px;}
    .top-bar{display:flex;justify-content:flex-end;margin-bottom:10px;}
    select{background:#020617;color:#38bdf8;border:1px solid #1e293b;padding:5px 10px;border-radius:6px;}
    .content{display:flex;gap:20px;}
    .table-box,.chart-box{flex:1;border:1px solid #1e293b;border-radius:10px;padding:10px;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{border:1px solid #1e293b;padding:6px;text-align:center;}
    th{color:#38bdf8;font-size:12px;}
    footer{text-align:center;margin-top:20px;color:#64748b;}
    @media(max-width:900px){.content{flex-direction:column;}}
  </style>
</head>
<body>

<div class="container">
  <h1>Infosys Stock Tracker</h1>
  <div class="subtitle">Last 7 Days Price Movement</div>

  <div class="top-bar">
    <select id="intervalSelect">
      <option value="1m">1 min</option>
      <option value="5m">5 min</option>
      <option value="1h" selected>1 hr</option>
      <option value="1d">1 day</option>
    </select>
  </div>

  <div class="content">
    <div class="table-box">
      <table id="stockTable">
        <thead><tr><th>Date</th><th>Price</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="chart-box">
      <canvas id="priceChart"></canvas>
    </div>
  </div>

  <footer>Made by Pranav</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;

function parseCSV(text){
  const rows=text.trim().split("\n").slice(1);
  return rows.map(r=>{
    const p=r.split(",");
    return [p[0], p.slice(2).join(",")];
  });
}

function mergeData(a,b){
  const map={};
  [...a,...b].forEach(r=>{ map[r[0]]=r; });
  return Object.values(map).sort((x,y)=>new Date(x[0])-new Date(y[0]));
}

function groupData(data, mode){
  const oneWeekAgo=new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate()-7);
  const filtered=data.filter(r=>new Date(r[0])>=oneWeekAgo);
  const result=[], seen=new Set();

  filtered.forEach(r=>{
    const dt=new Date(r[0]);
    let key;
    if(mode==="1m") key=dt.getHours()+":"+dt.getMinutes();
    if(mode==="5m") key=dt.getHours()+":"+Math.floor(dt.getMinutes()/5);
    if(mode==="1h") key=dt.getDate()+"-"+dt.getHours();
    if(mode==="1d") key=dt.getDate();
    if(!seen.has(key)){ seen.add(key); result.push(r); }
  });
  return result;
}

function render(data){
  const mode=intervalSelect.value;
  const rows=groupData(data,mode);
  const tbody=document.querySelector("#stockTable tbody");
  tbody.innerHTML="";
  const labels=[], prices=[];

  rows.forEach(r=>{
    const dt=new Date(r[0]);
    const date=dt.toLocaleDateString(undefined,{day:"2-digit",month:"short"});
    const time=dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const label=mode==="1d"?date:date+" "+time;
    tbody.innerHTML+=`<tr><td>${label}</td><td>â‚¹ ${r[1]}</td></tr>`;
    labels.push(label); prices.push(parseFloat(r[1]));
  });

  if(chart) chart.destroy();
  chart=new Chart(priceChart,{
    type:"line",
    data:{labels,datasets:[{label:"Infosys Price",data:prices,borderColor:"#38bdf8",
      backgroundColor:"rgba(56,189,248,0.1)",fill:true,tension:0.4,pointRadius:3}]},
    options:{responsive:true,plugins:{legend:{labels:{color:"#e5e7eb"}}},
      scales:{x:{ticks:{color:"#94a3b8"}},y:{ticks:{color:"#94a3b8"}}}}
  });
}

async function refreshData(){
  let sheetData=[], localData=[];
  try{
    const r1=await fetch("/api/sheet?ts="+Date.now());
    sheetData=parseCSV(await r1.text());
  }catch(e){console.log("Sheet fetch failed");}

  try{
    const r2=await fetch("/data/stock_data.csv?ts="+Date.now());
    localData=parseCSV(await r2.text());
  }catch(e){console.log("CSV fetch failed");}

  const finalData=mergeData(sheetData,localData);
  if(finalData.length) render(finalData);
}

intervalSelect.addEventListener("change", refreshData);
refreshData();
setInterval(refreshData,10000);
</script>

</body>
</html>
